<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Things Take Time | My Archive</title>
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap');

        :root {
            --bg: #F5F5F0; --text: #333; --accent: #FF5A5F; --card: #ffffff;
        }
        body { font-family: 'Noto Serif KR', serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        .nav { display: flex; justify-content: center; gap: 40px; padding: 30px 0; border-bottom: 1px solid #ddd; font-weight: 600; font-size: 0.9rem; }
        .site-title { text-align: center; font-size: 2.8rem; margin: 50px 0; font-weight: 800; letter-spacing: -1px; }

        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }

        /* 입력 영역 디자인 */
        .input-section { background: var(--card); padding: 30px; border-radius: 2px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 60px; border: 1px solid #eee; }
        .search-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 0; background: #fff; font-family: inherit; box-sizing: border-box; }
        button { padding: 12px 24px; background: #333; color: #fff; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: var(--accent); }

        /* 갤러리 그리드 */
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 40px; padding-bottom: 100px; }
        .book-item { text-align: center; position: relative; }
        .book-cover { width: 100%; aspect-ratio: 3/4.5; object-fit: cover; box-shadow: 5px 15px 25px rgba(0,0,0,0.1); border-radius: 2px; transition: 0.4s; }
        .book-item:hover .book-cover { transform: translateY(-8px); }
        .book-title { font-size: 0.95rem; font-weight: 700; margin: 12px 0 4px; line-height: 1.3; }
        .book-author { font-size: 0.8rem; color: #888; }
        
        .delete-btn { position: absolute; top: -5px; right: -5px; background: #333; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 10px; border: none; cursor: pointer; opacity: 0; transition: 0.2s; }
        .book-item:hover .delete-btn { opacity: 0.7; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="nav">
    <span>Archive</span>
    <span style="border-bottom: 2px solid #333;">Books</span>
    <span>Insights</span>
</div>

<div class="site-title">Things Take Time</div>

<div class="container">
    <div id="loginSection" style="text-align: center; padding: 100px 0;">
        <button onclick="login()" style="font-size: 1.1rem;">나의 서재 열기 (Google)</button>
    </div>

    <div id="appContents" class="hidden">
        <div class="input-section">
            <div class="search-row">
                <input type="text" id="searchInput" placeholder="책 제목을 입력하고 엔터를 누르세요.">
                <button onclick="searchKakaoBook()">Search</button>
            </div>
            <input type="text" id="title" placeholder="제목" readonly style="background:#f9f9f9; margin-bottom:10px;">
            <input type="text" id="author" placeholder="저자" readonly style="background:#f9f9f9; margin-bottom:10px;">
            <input type="hidden" id="coverUrl">
            <textarea id="review" rows="2" placeholder="이 책에 대한 한 줄 평을 남겨주세요."></textarea>
            <button onclick="addBook()" style="width:100%; margin-top:15px; background:var(--accent);">서재에 담기</button>
            <button onclick="logout()" style="background:none; color:#bbb; font-size:0.75rem; margin-top:15px; text-decoration:underline;">Logout</button>
        </div>

        <div class="book-grid" id="bookGrid"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBosa3su7U1VkjezE9tAFdymfd3J3Xaqcc",
        authDomain: "book-archive-48b1b.firebaseapp.com",
        projectId: "book-archive-48b1b",
        storageBucket: "book-archive-48b1b.firebasestorage.app",
        messagingSenderId: "761834872230",
        appId: "1:761834872230:web:f4927924a2412948da4367"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appContents').classList.remove('hidden');
            loadBooks(user.uid);
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('appContents').classList.add('hidden');
        }
    });

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);

    // 카카오 도서 검색 기능 (지은님이 발급받은 키 적용)
    window.searchKakaoBook = async () => {
        const queryStr = document.getElementById('searchInput').value;
        const KAKAO_KEY = 'f0eb55286c9b77ba1362dd14b32e0643';
        
        if(!queryStr) return;

        const response = await fetch(`https://dapi.kakao.com/v3/search/book?query=${queryStr}`, {
            headers: { Authorization: `KakaoAK ${KAKAO_KEY}` }
        });
        const data = await response.json();
        
        if(data.documents.length > 0) {
            const book = data.documents[0];
            document.getElementById('title').value = book.title;
            document.getElementById('author').value = book.authors.join(', ');
            document.getElementById('coverUrl').value = book.thumbnail;
        }
    };

    window.addBook = async () => {
        const title = document.getElementById('title').value;
        const coverUrl = document.getElementById('coverUrl').value;
        if (!title) return alert('책을 먼저 검색해주세요!');

        await addDoc(collection(db, "books"), {
            uid: auth.currentUser.uid,
            title,
            author: document.getElementById('author').value,
            coverUrl: coverUrl || 'https://via.placeholder.com/150x220?text=No+Cover',
            review: document.getElementById('review').value,
            createdAt: new Date()
        });
        ['searchInput', 'title', 'author', 'coverUrl', 'review'].forEach(id => document.getElementById(id).value = '');
    };

    function loadBooks(uid) {
        const q = query(collection(db, "books"), where("uid", "==", uid), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = snapshot.docs.map(d => {
                const b = d.data();
                return `
                    <div class="book-item">
                        <img src="${b.coverUrl}" class="book-cover">
                        <div class="book-title">${b.title}</div>
                        <div class="book-author">${b.author}</div>
                        <button class="delete-btn" onclick="deleteBook('${d.id}')">✕</button>
                    </div>
                `;
            }).join('');
        });
    }

    window.deleteBook = async (id) => {
        if (confirm('이 기록을 삭제하시겠어요?')) await deleteDoc(doc(db, "books", id));
    };
</script>
</body>
</html>