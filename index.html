<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Things Take Time | Archive</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap');

        :root {
            --bg: #F5F5F0; --text: #333; --accent: #FF5A5F; --card: #ffffff;
        }
        body { font-family: 'Noto Serif KR', serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        * { box-sizing: border-box; /* ë°˜ì‘í˜•ì„ ìœ„í•œ ë°•ìŠ¤ ëª¨ë¸ í†µì¼ */ }

        /* í—¤ë” & ë„¤ë¹„ê²Œì´ì…˜ */
        .nav { display: flex; justify-content: center; gap: 40px; padding: 30px 0; border-bottom: 1px solid #ddd; font-weight: 600; font-size: 0.9rem; }
        .nav span { cursor: pointer; color: #999; transition: 0.3s; }
        .nav span.active { color: #333; border-bottom: 2px solid #333; }
        .site-title { text-align: center; font-size: 3rem; margin: 60px 0; font-weight: 800; letter-spacing: -1px; cursor: pointer; word-break: keep-all; padding: 0 20px; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

        /* ì…ë ¥ ì„¹ì…˜ */
        .input-section { background: var(--card); padding: 40px; border-radius: 2px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 80px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 15px; border: 1px solid #ddd; font-family: inherit; -webkit-appearance: none; border-radius: 0; }
        .search-box button { white-space: nowrap; padding: 0 30px; background: #333; color: #fff; border: none; cursor: pointer; font-weight: bold; border-radius: 0; }

        .detail-fields input, .detail-fields textarea { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; margin-bottom: 10px; font-family: inherit; -webkit-appearance: none; border-radius: 0; }
        .save-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ë°˜ì‘í˜• ì ìš©) */
        .book-grid { 
            display: grid; 
            /* PCì—ì„œëŠ” 200px ê¸°ì¤€, ëª¨ë°”ì¼ì—ì„œëŠ” ë” ì‘ê²Œ ìë™ ì¡°ì ˆ */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 40px; padding-bottom: 100px; 
        }
        .book-item { text-align: center; position: relative; cursor: pointer; transition: 0.4s; }
        .book-cover { width: 100%; aspect-ratio: 3/4.5; object-fit: cover; box-shadow: 8px 8px 20px rgba(0,0,0,0.1); border-radius: 2px; margin-bottom: 15px; }
        .book-item:hover { transform: translateY(-5px); }
        .book-title { font-size: 0.95rem; font-weight: 700; margin-bottom: 5px; line-height: 1.3; word-break: keep-all; }
        .book-author { font-size: 0.85rem; color: #888; }
        
        /* [ìˆ˜ì •] ì‚­ì œ ë²„íŠ¼ ì™„ë²½í•œ ì •ì›í˜• ë§Œë“¤ê¸° */
        .delete-btn { 
            position: absolute; top: -8px; right: -8px; 
            background: #333; color: white; 
            width: 26px; height: 26px; /* ì •ì‚¬ê°í˜• í¬ê¸° ì§€ì • */
            border-radius: 50%; /* ì™„ë²½í•œ ì›í˜• */
            font-size: 16px; line-height: 1;
            display: flex; align-items: center; justify-content: center; 
            border: none; cursor: pointer; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            aspect-ratio: 1 / 1; /* ë¹„ìœ¨ ê³ ì • */
        }

        /* ìƒì„¸ ë¦¬ë·° ëª¨ë‹¬ (ë°˜ì‘í˜•) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: #fff; width: 100%; max-width: 800px; display: flex; gap: 30px; padding: 40px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; z-index: 1; }
        .modal-img { width: 280px; object-fit: cover; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); align-self: flex-start; }
        .modal-info { flex: 1; }
        .modal-info h2 { margin-top: 0; font-size: 1.8rem; line-height: 1.2; }
        .modal-review { margin-top: 25px; line-height: 1.7; color: #555; border-top: 1px solid #eee; padding-top: 20px; white-space: pre-line; }

        .hidden { display: none; }

        /* ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media (max-width: 768px) {
            .site-title { font-size: 2rem; margin: 40px 0; }
            .nav { gap: 20px; padding: 20px 0; font-size: 0.85rem; }
            .container { padding: 0 15px; }
            .input-section { padding: 25px; margin-bottom: 40px; }
            
            /* ëª¨ë°”ì¼ì—ì„œ ê·¸ë¦¬ë“œ ê°„ê²© ë° í¬ê¸° ì¡°ì • (2ì—´ ìœ ì§€ ë…¸ë ¥) */
            .book-grid { 
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
                gap: 20px; column-gap: 20px;
            }
            .book-title { font-size: 0.9rem; }
            
            /* ëª¨ë‹¬ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
            .modal-content { flex-direction: column; padding: 30px 20px; }
            .modal-img { width: 160px; margin: 0 auto 20px; align-self: center; }
            .modal-info h2 { font-size: 1.5rem; text-align: center; }
            .modal-info p { text-align: center; }
        }
    </style>
</head>
<body>

<div class="nav">
    <span onclick="filterCat('Furniture')" id="menu-Furniture">Furniture</span>
    <span onclick="filterCat('Books')" id="menu-Books" class="active">Books</span>
    <span onclick="filterCat('Life')" id="menu-Life">Life</span>
</div>

<div class="site-title" onclick="location.reload()">Things Take Time</div>

<div class="container">
    <div id="loginSection" style="text-align: center; padding: 80px 0;">
        <p style="margin-bottom: 20px; color: #666;">ë‚˜ë§Œì˜ ì˜ê°ì„ ìˆ˜ì§‘í•˜ëŠ” ê³µê°„</p>
        <button onclick="login()" style="padding: 15px 30px; font-size: 1rem; cursor: pointer; background: #333; color: white; border: none; font-family: inherit;">Google ê³„ì •ìœ¼ë¡œ ì‹œì‘</button>
    </div>

    <div id="appContents" class="hidden">
        <div class="input-section" id="addSection">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰í•  ë„ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.">
                <button onclick="searchKakaoBook()">ê²€ìƒ‰</button>
            </div>
            <div class="detail-fields">
                <input type="text" id="title" placeholder="ì œëª©" readonly style="color:#999;">
                <input type="text" id="author" placeholder="ì €ì" readonly style="color:#999;">
                <input type="hidden" id="coverUrl">
                <textarea id="review" rows="4" placeholder="ì´ ì±…ì—ì„œ ì–»ì€ ì˜ê°ì„ ê¸°ë¡í•´ì£¼ì„¸ìš”."></textarea>
                <button class="save-btn" onclick="addBook()">Archive ì €ì¥</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="logout()" style="background:none; border:none; color:#bbb; text-decoration:underline; cursor:pointer; font-size: 0.8rem;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="book-grid" id="bookGrid"></div>
    </div>
</div>

<div id="bookModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="closeModal()">Ã—</span>
        <img id="modalImg" class="modal-img" src="">
        <div class="modal-info">
            <h2 id="modalTitle">ì œëª©</h2>
            <p id="modalAuthor" style="color:#888;">ì €ì</p>
            <div id="modalReview" class="modal-review"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ì§€ì€ë‹˜ì˜ Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyBosa3su7U1VkjezE9tAFdymfd3J3Xaqcc",
        authDomain: "book-archive-48b1b.firebaseapp.com",
        projectId: "book-archive-48b1b",
        storageBucket: "book-archive-48b1b.firebasestorage.app",
        messagingSenderId: "761834872230",
        appId: "1:761834872230:web:f4927924a2412948da4367"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let currentCategory = 'Books';

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appContents').classList.remove('hidden');
            loadData(user.uid);
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('appContents').classList.add('hidden');
        }
    });

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);

    window.filterCat = (cat) => {
        currentCategory = cat;
        document.querySelectorAll('.nav span').forEach(s => s.classList.remove('active'));
        document.getElementById(`menu-${cat}`).classList.add('active');
        document.getElementById('addSection').style.display = (cat === 'Books') ? 'block' : 'none';
        if(auth.currentUser) loadData(auth.currentUser.uid);
    };

    // ì¹´ì¹´ì˜¤ ê²€ìƒ‰ (í‚¤ ì ìš©ë¨)
    window.searchKakaoBook = async () => {
        const queryStr = document.getElementById('searchInput').value;
        const KAKAO_KEY = 'f0eb55286c9b77ba1362dd14b32e0643'; 
        if(!queryStr) return;
        const response = await fetch(`https://dapi.kakao.com/v3/search/book?query=${queryStr}`, { headers: { Authorization: `KakaoAK ${KAKAO_KEY}` } });
        const data = await response.json();
        if(data.documents.length > 0) {
            const book = data.documents[0];
            document.getElementById('title').value = book.title;
            document.getElementById('author').value = book.authors.join(', ');
            document.getElementById('coverUrl').value = book.thumbnail;
        }
    };

    window.addBook = async () => {
        const title = document.getElementById('title').value;
        if (!title) return alert('ê²€ìƒ‰ì„ í†µí•´ ì±…ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
        await addDoc(collection(db, "archive"), {
            uid: auth.currentUser.uid, category: 'Books', title,
            author: document.getElementById('author').value, coverUrl: document.getElementById('coverUrl').value,
            review: document.getElementById('review').value, createdAt: new Date()
        });
        ['searchInput', 'title', 'author', 'coverUrl', 'review'].forEach(id => document.getElementById(id).value = '');
    };

    function loadData(uid) {
        const q = query(collection(db, "archive"), where("uid", "==", uid), where("category", "==", currentCategory), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = snapshot.docs.map(d => {
                const b = d.data();
                // ë¦¬ë·° ë‚´ìš© ì¤‘ ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜ ì²˜ë¦¬ (ëª¨ë‹¬ ì „ë‹¬ìš©)
                const escapedReview = (b.review || "").replace(/(\r\n|\n|\r)/g, '<br>');
                return `
                    <div class="book-item" onclick="openModal('${b.title.replace(/'/g, "\\'")}', '${b.author}', '${b.coverUrl}', \`${escapedReview}\`)">
                        <img src="${b.coverUrl}" class="book-cover">
                        <div class="book-title">${b.title}</div>
                        <div class="book-author">${b.author}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteItem('${d.id}')">Ã—</button>
                    </div>
                `;
            }).join('');
        });
    }

    window.deleteItem = async (id) => { if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await deleteDoc(doc(db, "archive", id)); };

    // ëª¨ë‹¬ ê¸°ëŠ¥ (ë°˜ì‘í˜• ëŒ€ì‘)
    window.openModal = (title, author, img, reviewBr) => {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalAuthor').innerText = author;
        document.getElementById('modalImg').src = img;
        // innerHTMLì„ ì‚¬ìš©í•˜ì—¬ <br> íƒœê·¸ê°€ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì ìš©ë˜ë„ë¡ í•¨
        document.getElementById('modalReview').innerHTML = reviewBr || "ì‘ì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
        document.getElementById('bookModal').style.display = 'flex';
        document.body.style.overflow = 'hidden'; // ëª¨ë‹¬ ë–´ì„ ë•Œ ë°°ê²½ ìŠ¤í¬ë¡¤ ë§‰ê¸°
    };

    window.closeModal = (e) => {
        document.getElementById('bookModal').style.display = 'none';
        document.body.style.overflow = 'auto'; // ìŠ¤í¬ë¡¤ ë‹¤ì‹œ í—ˆìš©
    };
    document.getElementById('searchInput')?.addEventListener('keypress', (e) => { if(e.key === 'Enter') searchKakaoBook(); });
</script>
</body>
</html>