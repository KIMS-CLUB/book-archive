<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Things Take Time | Archive</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap');

        :root {
            --bg: #F5F5F0; --text: #333; --accent: #FF5A5F; --card: #ffffff;
        }
        body { font-family: 'Noto Serif KR', serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        * { box-sizing: border-box; }

        .nav { display: flex; justify-content: center; gap: 40px; padding: 30px 0; border-bottom: 1px solid #ddd; font-weight: 600; font-size: 0.9rem; }
        .nav span { cursor: pointer; color: #999; transition: 0.3s; }
        .nav span.active { color: #333; border-bottom: 2px solid #333; }
        .site-title { text-align: center; font-size: 3rem; margin: 60px 0; font-weight: 800; letter-spacing: -1px; cursor: pointer; word-break: keep-all; padding: 0 20px; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

        /* 입력 섹션 */
        .input-section { background: var(--card); padding: 40px; border-radius: 2px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 80px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 15px; border: 1px solid #ddd; font-family: inherit; border-radius: 0; }
        .search-box button { white-space: nowrap; padding: 0 30px; background: #333; color: #fff; border: none; cursor: pointer; font-weight: bold; }

        .detail-fields input, .detail-fields textarea { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; margin-bottom: 10px; font-family: inherit; border-radius: 0; }
        .save-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* 그리드 레이아웃 */
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 40px; padding-bottom: 100px; }
        .book-item { text-align: center; position: relative; cursor: pointer; transition: 0.4s; }
        .book-cover { width: 100%; aspect-ratio: 3/4.5; object-fit: cover; box-shadow: 8px 8px 20px rgba(0,0,0,0.1); border-radius: 2px; margin-bottom: 15px; }
        .book-item:hover { transform: translateY(-5px); }
        .book-title { font-size: 0.95rem; font-weight: 700; margin-bottom: 5px; line-height: 1.3; word-break: keep-all; }
        .book-author { font-size: 0.85rem; color: #888; }
        
        .delete-btn { 
            position: absolute; top: -8px; right: -8px; background: #333; color: white; 
            width: 26px; height: 26px; border-radius: 50%; font-size: 16px; 
            display: flex; align-items: center; justify-content: center; 
            border: none; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* 리뷰 수정 모달 */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: #fff; width: 100%; max-width: 850px; display: flex; gap: 40px; padding: 50px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; z-index: 1; }
        .modal-img-wrapper { width: 280px; flex-shrink: 0; }
        .modal-img { width: 100%; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); }
        .modal-form { flex: 1; }
        .modal-form h2 { margin-top: 0; font-size: 1.8rem; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; font-size: 0.85rem; color: #888; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; font-family: inherit; font-size: 0.95rem; }
        
        .update-btn { width: 100%; padding: 15px; background: #333; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }

        .hidden { display: none; }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .site-title { font-size: 2.2rem; margin: 40px 0; }
            .modal-content { flex-direction: column; padding: 30px 20px; }
            .modal-img-wrapper { width: 150px; margin: 0 auto 20px; }
        }
    </style>
</head>
<body>

<div class="nav">
    <span onclick="filterCat('Furniture')" id="menu-Furniture">Furniture</span>
    <span onclick="filterCat('Books')" id="menu-Books" class="active">Books</span>
    <span onclick="filterCat('Life')" id="menu-Life">Life</span>
</div>

<div class="site-title" onclick="location.reload()">Things Take Time</div>

<div class="container">
    <div id="loginSection" style="text-align: center; padding: 80px 0;">
        <button onclick="login()" style="padding: 15px 30px; background: #333; color: white; border: none; cursor: pointer; font-family: inherit;">Google로 시작하기</button>
    </div>

    <div id="appContents" class="hidden">
        <div class="input-section" id="addSection">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="아카이브할 책 제목을 검색하세요.">
                <button onclick="searchKakaoBook()">검색</button>
            </div>
            <div class="detail-fields">
                <input type="text" id="title" placeholder="제목" readonly>
                <input type="text" id="author" placeholder="저자" readonly>
                <input type="hidden" id="coverUrl">
                <button class="save-btn" onclick="addBook()">내 서재에 등록</button>
            </div>
        </div>

        <div class="book-grid" id="bookGrid"></div>
    </div>
</div>

<div id="bookModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="closeModal()">×</span>
        <div class="modal-img-wrapper">
            <img id="modalImg" class="modal-img" src="">
        </div>
        <div class="modal-form">
            <input type="hidden" id="editDocId">
            <h2 id="modalTitle">책 제목</h2>
            <p id="modalAuthor" style="color:#888; margin-bottom: 30px;">저자</p>
            
            <div class="form-group">
                <label>읽은 날짜</label>
                <input type="date" id="editDateRead">
            </div>
            <div class="form-group">
                <label>핵심 기록 (기억하고 싶은 문장 등)</label>
                <textarea id="editNotes" rows="3" placeholder="기록하고 싶은 내용을 적어주세요."></textarea>
            </div>
            <div class="form-group">
                <label>나의 감상</label>
                <textarea id="editReview" rows="5" placeholder="이 책을 읽고 어떤 영감을 얻으셨나요?"></textarea>
            </div>
            
            <button class="update-btn" onclick="updateBook()">영감 기록하기</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBosa3su7U1VkjezE9tAFdymfd3J3Xaqcc",
        authDomain: "book-archive-48b1b.firebaseapp.com",
        projectId: "book-archive-48b1b",
        storageBucket: "book-archive-48b1b.firebasestorage.app",
        messagingSenderId: "761834872230",
        appId: "1:761834872230:web:f4927924a2412948da4367"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let currentCategory = 'Books';

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appContents').classList.remove('hidden');
            loadData(user.uid);
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('appContents').classList.add('hidden');
        }
    });

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);

    // 검색 기능
    window.searchKakaoBook = async () => {
        const queryStr = document.getElementById('searchInput').value;
        const KAKAO_KEY = 'f0eb55286c9b77ba1362dd14b32e0643'; 
        if(!queryStr) return;
        const response = await fetch(`https://dapi.kakao.com/v3/search/book?query=${queryStr}`, { headers: { Authorization: `KakaoAK ${KAKAO_KEY}` } });
        const data = await response.json();
        if(data.documents.length > 0) {
            const book = data.documents[0];
            document.getElementById('title').value = book.title;
            document.getElementById('author').value = book.authors.join(', ');
            document.getElementById('coverUrl').value = book.thumbnail;
        }
    };

    // 데이터 초기 등록 (제목/이미지 위주)
    window.addBook = async () => {
        const title = document.getElementById('title').value;
        if (!title) return alert('검색을 통해 책을 먼저 선택하세요.');
        await addDoc(collection(db, "archive"), {
            uid: auth.currentUser.uid,
            category: 'Books',
            title,
            author: document.getElementById('author').value,
            coverUrl: document.getElementById('coverUrl').value,
            dateRead: "",
            notes: "",
            review: "",
            createdAt: new Date()
        });
        ['searchInput', 'title', 'author', 'coverUrl'].forEach(id => document.getElementById(id).value = '');
        alert('서재에 등록되었습니다. 이미지를 눌러 리뷰를 작성해보세요!');
    };

    function loadData(uid) {
        const q = query(collection(db, "archive"), where("uid", "==", uid), where("category", "==", currentCategory), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = snapshot.docs.map(d => {
                const b = d.data();
                // 데이터 전체를 JSON 형태로 모달에 전달
                const bookData = JSON.stringify({
                    id: d.id,
                    title: b.title.replace(/'/g, "\\'"),
                    author: b.author,
                    img: b.coverUrl,
                    dateRead: b.dateRead || "",
                    notes: (b.notes || "").replace(/\n/g, "\\n"),
                    review: (b.review || "").replace(/\n/g, "\\n")
                });
                return `
                    <div class="book-item" onclick='openEditModal(${bookData})'>
                        <img src="${b.coverUrl}" class="book-cover">
                        <div class="book-title">${b.title}</div>
                        <div class="book-author">${b.author}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteItem('${d.id}')">×</button>
                    </div>
                `;
            }).join('');
        });
    }

    // 모달 열기 (데이터 채우기)
    window.openEditModal = (book) => {
        document.getElementById('editDocId').value = book.id;
        document.getElementById('modalTitle').innerText = book.title;
        document.getElementById('modalAuthor').innerText = book.author;
        document.getElementById('modalImg').src = book.img;
        document.getElementById('editDateRead').value = book.dateRead;
        document.getElementById('editNotes').value = book.notes;
        document.getElementById('editReview').value = book.review;
        
        document.getElementById('bookModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };

    // 리뷰 데이터 업데이트 (수정 저장)
    window.updateBook = async () => {
        const docId = document.getElementById('editDocId').value;
        const docRef = doc(db, "archive", docId);
        
        await updateDoc(docRef, {
            dateRead: document.getElementById('editDateRead').value,
            notes: document.getElementById('editNotes').value,
            review: document.getElementById('editReview').value
        });
        
        alert('영감이 성공적으로 기록되었습니다.');
        closeModal();
    };

    window.closeModal = () => {
        document.getElementById('bookModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    };

    window.deleteItem = async (id) => { if (confirm('삭제하시겠습니까?')) await deleteDoc(doc(db, "archive", id)); };
    window.filterCat = (cat) => {
        currentCategory = cat;
        document.querySelectorAll('.nav span').forEach(s => s.classList.remove('active'));
        document.getElementById(`menu-${cat}`).classList.add('active');
        document.getElementById('addSection').style.display = (cat === 'Books') ? 'block' : 'none';
        if(auth.currentUser) loadData(auth.currentUser.uid);
    };
    document.getElementById('searchInput')?.addEventListener('keypress', (e) => { if(e.key === 'Enter') searchKakaoBook(); });
</script>
</body>
</html>